WITH CLIENTES AS (SELECT P.ID 
FROM FINANCAS.ITENSCONTRATOS IC
INNER JOIN FINANCAS.CONTRATOS C ON C.CONTRATO = IC.CONTRATO
INNER JOIN NS.PESSOAS P ON P.ID = C.PARTICIPANTE
INNER JOIN CRM.SEGMENTOSATUACAO S ON P.SEGMENTOATUACAO = S.SEGMENTOATUACAO
INNER JOIN SERVICOS.SERVICOS SE ON SE.ID = IC.SERVICO
INNER JOIN NS.ENDERECOS EN ON EN.ID_PESSOA = P.ID AND EN.TIPOENDERECO = 0
WHERE C.TIPOCONTRATO = 1
AND IC.CANCELADO = FALSE
AND IC.PROCESSADO = TRUE
AND IC.VALOR > 0
AND C.PERFILCONTRATO = 'S'::CHARACTER
AND IC.RECORRENTE = TRUE
AND IC.UNIDADENATUREZA = 2
AND IC.UNIDADEINTERVALONATUREZA = 2
AND SE.SERVICO IN ( 'MET', 'MCW', 'MZW', 'MST', 'MCW2', 'MET2', 'MCMN', 'MCMRNFCE', 'MCMR', 'MMW')
GROUP BY P.ID
)
SELECT P.PESSOA "CÓDIGO",P.NOME "RAZÃO SOCIAL", P.NOMEFANTASIA, REPLACE(SUM((IC.VALOR*IC.QUANTIDADE)::NUMERIC(15,2))::TEXT, '.', ',') "TOTAL MANUTENÇÃO", S.DESCRICAO "SEGMENTO", EN.UF "UF"
FROM FINANCAS.ITENSCONTRATOS IC
INNER JOIN FINANCAS.CONTRATOS C ON C.CONTRATO = IC.CONTRATO
INNER JOIN NS.PESSOAS P ON P.ID = C.PARTICIPANTE
INNER JOIN CLIENTES A ON A.ID = P.ID
INNER JOIN CRM.SEGMENTOSATUACAO S ON P.SEGMENTOATUACAO = S.SEGMENTOATUACAO
INNER JOIN NS.ENDERECOS EN ON EN.ID_PESSOA = P.ID AND EN.TIPOENDERECO = 0
WHERE C.TIPOCONTRATO = 1
AND IC.CANCELADO = FALSE
AND IC.PROCESSADO = TRUE
AND IC.VALOR > 0
AND C.PERFILCONTRATO = 'S'::CHARACTER
AND IC.RECORRENTE = TRUE
AND IC.UNIDADENATUREZA = 2
AND IC.UNIDADEINTERVALONATUREZA = 2
AND IC.SERVICO IN('38BB9516-8F3A-43BA-9BC2-15382159D8F1', '56CBA110-9DB4-49E1-8324-A37ACCE0AF8A',
'6C210F51-E954-4FC7-A7F4-291DA46CEDB8', 'A668312C-2862-4AFC-84ED-E2C5440E4032',
'36519B41-373C-4E2E-8377-0FF3C5F54CE1', '47A5188F-ED8F-43B8-A52A-13E4D322AA2D',
'A4D84253-F7AA-4228-9FCF-998A83A9059A', 'A479AEC5-32DA-4F59-BA3F-F6A060C67527', 
'C2B60877-5A2C-429F-86FB-EA67BBCB5C08', '79D51746-208F-4339-BC72-C7998D0B0C1C')
GROUP BY P.ID, S.DESCRICAO, EN.UF
ORDER BY SUM(IC.VALOR*IC.QUANTIDADE)::NUMERIC DESC
